<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Local Storage Fitness Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Darker gray background */
            color: #e5e7eb; /* Light text for contrast */
        }
        /* Custom scrollbar for workout list (mainly for landscape/tablet) */
        .workout-list::-webkit-scrollbar {
            width: 6px;
        }
        .workout-list::-webkit-scrollbar-thumb {
            background-color: #2dd4bf; 
            border-radius: 3px;
        }
        .workout-list::-webkit-scrollbar-track {
            background-color: #374151; 
        }
        /* Chart container height optimized for mobile screen vertical space */
        .chart-container {
            position: relative;
            height: 40vh; /* Takes up a significant portion of the screen height */
            width: 100%;
            margin-bottom: 2rem;
            background-color: #374151; 
            border-radius: 0.75rem; 
        }
        /* Ensure input focus is clear for touch */
        input:focus {
            outline: 2px solid #2dd4bf;
            outline-offset: 2px;
        }
        /* Hide numbers from number input fields on mobile */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 pb-12">
        
        <!-- Header & Status (Mobile Optimized) -->
        <header class="text-center mb-6 pt-4">
            <h1 class="text-3xl font-extrabold text-white mb-1 tracking-tight">
                <i data-lucide="zap" class="inline-block w-6 h-6 text-teal-400 mr-1"></i>
                Local Fitness Log
            </h1>
            <p class="text-sm text-yellow-400 font-medium mb-3">Data is stored in this browser only.</p>
        </header>

        
        <div class="max-w-xl mx-auto space-y-8">

            
            <!-- Log Session Form -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                    <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-teal-400"></i> Log New Session
                </h2>

                <form id="workout-form" class="space-y-5">
                    
                    <div>
                        <label for="workout-date" class="block text-sm font-semibold text-gray-300 mb-1">Date</label>
                        <input type="date" id="workout-date" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-xl focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                    </div>

                    
                    <div class="flex space-x-2 bg-gray-700 p-1 rounded-xl">
                        <button type="button" onclick="setWorkoutType('weight')" id="weight-type-btn" class="flex-1 py-3 text-sm font-bold rounded-lg transition-colors duration-200 focus:outline-none"></button>
                        <button type="button" onclick="setWorkoutType('cardio')" id="cardio-type-btn" class="flex-1 py-3 text-sm font-bold rounded-lg transition-colors duration-200 focus:outline-none"></button>
                    </div>

                    
                    <div>
                        <label for="workout-name" class="block text-sm font-semibold text-gray-300 mb-1">Exercise Name (Autocompletes)</label>
                        <input type="text" id="workout-name" required placeholder="Bench Press, Running, etc." 
                                list="exercise-suggestions"
                                class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-xl focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                        
                        
                        <datalist id="exercise-suggestions">
                            
                        </datalist>
                    </div>

                    
                    <div id="conditional-fields" class="space-y-4">
                        
                    </div>

                    <div id="form-actions" class="space-y-3 pt-2">
                        <button type="submit" id="log-btn" class="w-full py-3.5 px-4 bg-teal-500 hover:bg-teal-600 text-white font-bold rounded-xl shadow-lg shadow-teal-700/50 transition-all duration-300 transform active:scale-95 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50 text-base">
                            Log Workout
                        </button>
                        <button type="button" onclick="window.resetForm()" class="w-full py-3.5 px-4 bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold rounded-xl transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-gray-700 focus:ring-opacity-50 text-base">
                            Clear / Cancel Edit
                        </button>
                        <p id="form-message" class="text-center text-sm font-medium hidden"></p>
                    </div>
                </form>
            </div>
            
            <!-- Performance Dashboard -->
            <div id="dashboard-container" class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700 min-h-[400px]">
                
                <!-- DEDICATED SECTION HEADER -->
                <h2 class="text-2xl font-extrabold text-white mb-6 flex items-center tracking-tight">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-2 text-teal-400"></i> Performance Dashboard
                </h2>

                
                <div class="flex space-x-6 border-b border-gray-700 mb-6">
                    <button id="history-tab" onclick="activateTab('history')" class="pb-3 text-lg font-bold border-b-2"></button>
                    <button id="progress-tab" onclick="activateTab('progress')" class="pb-3 text-lg font-bold border-b-2"></button>
                </div>

                
                <div id="history-content" class="tab-content">
                    <h2 class="sr-only">Workout History</h2>
                    <div id="workout-list" class="workout-list space-y-4 max-h-[60vh] overflow-y-auto">
                         <div class="text-center text-gray-500 p-12 text-base italic">Loading workouts...</div>
                    </div>
                    <p id="no-workouts" class="text-center text-gray-500 p-12 hidden text-base italic">Start your fitness journey by logging your first workout!</p>
                </div>

                
                <div id="progress-content" class="tab-content hidden">
                    <h2 class="sr-only">Performance Insights</h2>
                    
                    
                    <div class="bg-gray-700 p-4 rounded-xl mb-6">
                        <h3 class="text-xl font-bold text-teal-300 mb-3">Weight Training: Max Lift</h3>
                        <div class="mb-4">
                            <label for="weight-exercise-selector" class="block text-sm font-medium text-gray-300 mb-1">Track Exercise:</label>
                            <select id="weight-exercise-selector" onchange="window.handleWeightExerciseChange(this.value)" 
                                class="p-2 bg-gray-600 text-white border border-gray-500 rounded-lg focus:ring-teal-500 focus:border-teal-500 w-full">
                                
                            </select>
                        </div>
                        <div class="chart-container p-2">
                            <canvas id="weight-chart"></canvas>
                        </div>
                    </div>


                    
                    <div class="bg-gray-700 p-4 rounded-xl">
                        <h3 class="text-xl font-bold text-blue-300 mb-3">Cardio Progress</h3>
                        
                        <div class="mb-4">
                            <label for="cardio-metric-selector" class="block text-sm font-medium text-gray-300 mb-1">Track Metric:</label>
                            <select id="cardio-metric-selector" onchange="window.handleCardioMetricChange(this.value)" 
                                class="p-2 bg-gray-600 text-white border border-gray-500 rounded-lg focus:ring-teal-500 focus:border-teal-500 w-full">
                                <option value="distance">Total Distance (km)</option>
                                <option value="time">Total Time (minutes)</option>
                                <option value="speed">Average Speed (km/h)</option>
                            </select>
                        </div>

                        <div class="chart-container p-2">
                            <canvas id="cardio-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100 border border-gray-700">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-white"></h3>
                <p id="modal-body" class="mb-6 text-gray-300 text-sm"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-secondary-btn" onclick="closeModal(true)" class="hidden py-2 px-4 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600 font-semibold transition duration-150 text-sm">Cancel</button>
                    <button id="modal-primary-btn" onclick="closeModal(false)" class="py-2 px-4 bg-teal-500 text-white rounded-xl hover:bg-teal-600 font-bold transition duration-150 text-sm">OK</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global variables
        const WORKOUTS_KEY = 'fitnessWorkouts';
        const EXERCISE_HISTORY_KEY = 'exerciseHistory';

        window.workouts = [];
        window.exerciseHistory = { weight: [], cardio: [] }; 
        window.editingWorkoutId = null; 
        window.currentTab = 'history'; 
        window.charts = {}; 

        // Charting state
        window.cardioMetric = 'distance'; 
        window.weightExercise = null; 

        // Global state for workout form
        window.currentWorkoutType = 'weight'; 
        const MAX_SETS = 5; 

        let resolveModalPromise = null;

        // Utility to generate unique ID locally
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
        
        // --- LOCAL STORAGE INTERACTION FUNCTIONS ---
        
        window.getWorkoutsFromLocal = function() {
            try {
                const stored = localStorage.getItem(WORKOUTS_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Error retrieving workouts from localStorage:", e);
                return [];
            }
        };

        window.saveWorkoutsToLocal = function(workouts) {
            try {
                localStorage.setItem(WORKOUTS_KEY, JSON.stringify(workouts));
            } catch (e) {
                console.error("Error saving workouts to localStorage:", e);
                window.showModal('Save Error', 'Could not save data locally. Your browser storage might be full.', false);
            }
        };

        window.getHistoryFromLocal = function() {
            try {
                const stored = localStorage.getItem(EXERCISE_HISTORY_KEY);
                return stored ? JSON.parse(stored) : { weight: [], cardio: [] };
            } catch (e) {
                console.error("Error retrieving history from localStorage:", e);
                return { weight: [], cardio: [] };
            }
        };

        window.saveHistoryToLocal = function(history) {
            try {
                localStorage.setItem(EXERCISE_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error("Error saving history to localStorage:", e);
            }
        };

        window.loadAndRenderWorkouts = function() {
            window.workouts = window.getWorkoutsFromLocal();
            // Sort by date (newest first)
            window.workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            window.exerciseHistory = window.getHistoryFromLocal();

            window.renderHistory(window.workouts);
            window.renderProgressChart(window.workouts);
            window.updateDatalistOptions(window.currentWorkoutType);
        };
        
        window.addExerciseToHistory = function(name, type) {
            const trimmedName = name.trim();
            
            if (trimmedName && type && window.exerciseHistory[type]) {
                if (!window.exerciseHistory[type].includes(trimmedName)) {
                    window.exerciseHistory[type].push(trimmedName);
                    window.exerciseHistory[type].sort();
                    window.saveHistoryToLocal(window.exerciseHistory);
                }
            }
        };

        // --- Core Application Setup ---
        
        window.setupEventListeners = function() {
            document.getElementById('workout-form').addEventListener('submit', window.handleFormSubmit);
            document.getElementById('workout-date').valueAsDate = new Date(); 

            window.activateTab('history'); 
            window.setWorkoutType('weight'); 
            lucide.createIcons();
            
            // Load initial data
            window.loadAndRenderWorkouts(); 
        };

        // --- UI State Management and Rendering (Mostly Unchanged) ---

        window.activateTab = function(tabName) {
            window.currentTab = tabName;
            const tabs = ['history', 'progress'];
            
            tabs.forEach(tab => {
                const btn = document.getElementById(`${tab}-tab`);
                const content = document.getElementById(`${tab}-content`);
                
                const isActive = tab === tabName;
                
                // Set text content for mobile tabs
                btn.textContent = tab.charAt(0).toUpperCase() + tab.slice(1);

                btn.classList.toggle('border-teal-400', isActive);
                btn.classList.toggle('text-teal-400', isActive);
                btn.classList.toggle('border-gray-700', !isActive);
                btn.classList.toggle('text-gray-400', !isActive);
                btn.classList.toggle('hover:text-teal-400', !isActive);
                content.classList.toggle('hidden', !isActive);
            });

            if (tabName === 'progress' && window.workouts.length > 0) {
                 window.renderProgressChart(window.workouts);
            }
        };

        window.renderHistory = function(workouts) {
            const listEl = document.getElementById('workout-list');
            const noWorkoutsEl = document.getElementById('no-workouts');
            listEl.innerHTML = ''; 

            if (workouts.length === 0) {
                noWorkoutsEl.classList.remove('hidden');
                return;
            }
            noWorkoutsEl.classList.add('hidden');

            workouts.forEach(workout => {
                const isWeight = workout.type === 'weight';
                let statsHtml = '';

                if (isWeight) {
                    const validSets = Array.isArray(workout.sets) ? workout.sets.filter(s => parseFloat(s.weight) > 0 || parseInt(s.reps) > 0) : [];
                    let maxWeight = 0;
                    if (validSets.length > 0) {
                         maxWeight = Math.max(...validSets.map(s => parseFloat(s.weight) || 0));
                    }
                    
                    statsHtml = `
                        <div class="flex items-center space-x-4">
                            <div class="flex flex-col items-center">
                                <span class="text-xl font-extrabold text-teal-300">${maxWeight.toFixed(1)}</span>
                                <span class="text-xs text-gray-400 font-medium">Max Lift (kg)</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-xl font-extrabold text-teal-300">${validSets.length}</span>
                                <span class="text-xs text-gray-400 font-medium">Total Sets</span>
                            </div>
                        </div>
                        <details class="mt-2 text-sm text-gray-400">
                            <summary class="font-semibold cursor-pointer hover:text-teal-400 transition duration-150">View Sets</summary>
                            <div class="mt-2 space-y-1 p-2 bg-gray-700 rounded-lg">
                                ${validSets.map(set => `
                                    <p class="text-xs">
                                        <span class="font-bold text-gray-200">Set ${set.set}:</span> ${set.weight} kg x ${set.reps} reps
                                    </p>
                                `).join('')}
                            </div>
                        </details>
                    `;

                } else { // Cardio
                    const distanceKm = window.parseDistance(workout.distance);
                    const timeMin = window.parseTime(workout.time);
                    const speed = window.parseSpeed(workout.speed);

                    statsHtml = `
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <p><span class="font-semibold text-blue-300">Dist:</span> ${distanceKm.toFixed(1)} km</p>
                            <p><span class="font-semibold text-blue-300">Time:</span> ${timeMin.toFixed(0)} min</p>
                            <p class="col-span-2"><span class="font-semibold text-blue-300">Speed:</span> ${speed.toFixed(1)} km/h</p>
                        </div>
                    `;
                }

                const workoutDate = new Date(workout.date).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric'
                });
                const workoutYear = new Date(workout.date).getFullYear();

                const icon = isWeight ? 'dumbbell' : 'run';
                const colorBg = 'bg-gray-700'; 
                const colorRing = isWeight ? 'text-teal-400 ring-teal-600' : 'text-blue-400 ring-blue-600';
                
                const html = `
                    <div class="p-4 ${colorBg} rounded-xl shadow-md border border-gray-600 flex items-start space-x-3 transition duration-200 hover:shadow-lg">
                        <div class="p-2 rounded-full ring-2 ${colorRing} flex-shrink-0">
                            <i data-lucide="${icon}" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="text-lg font-extrabold text-white truncate">${workout.name}</h3>
                                <div class="flex flex-col items-end text-xs text-gray-400 font-medium ml-4">
                                    <span>${workoutDate}</span>
                                    <span class="text-xs">${workoutYear}</span>
                                </div>
                            </div>
                            <div class="mt-1">
                                ${statsHtml}
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2 flex-shrink-0">
                            <button onclick="window.startEdit('${workout.id}')" class="p-2 text-gray-400 hover:text-teal-400 rounded-full transition duration-150 hover:bg-gray-600" aria-label="Edit Workout">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button onclick="window.deleteWorkout('${workout.id}')" class="p-2 text-gray-400 hover:text-red-400 rounded-full transition duration-150 hover:bg-gray-600" aria-label="Delete Workout">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
                listEl.insertAdjacentHTML('beforeend', html);
            });
            lucide.createIcons();
        }

        window.showModal = function(title, body, isConfirm = false) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            const modal = document.getElementById('modal');
            const secondaryBtn = document.getElementById('modal-secondary-btn');
            
            if (isConfirm) {
                secondaryBtn.classList.remove('hidden');
                document.getElementById('modal-primary-btn').textContent = 'Confirm';
                modal.classList.remove('hidden');

                return new Promise(resolve => {
                    resolveModalPromise = resolve;
                });
            } else {
                secondaryBtn.classList.add('hidden');
                document.getElementById('modal-primary-btn').textContent = 'OK';
                modal.classList.remove('hidden');
                return Promise.resolve(true); 
            }
        };

        window.closeModal = function(isCancel) {
            document.getElementById('modal').classList.add('hidden');
            if (resolveModalPromise) {
                resolveModalPromise(!isCancel); 
                resolveModalPromise = null;
            }
        };

        window.showFormMessage = function(message, colorClass, duration = 0) {
            const el = document.getElementById('form-message');
            el.textContent = message;
            el.className = `text-center text-sm font-medium mt-2 ${colorClass}`;
            el.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => el.classList.add('hidden'), duration);
            }
        };
        
        window.setWorkoutType = function(type) {
            window.currentWorkoutType = type;
            const fieldsEl = document.getElementById('conditional-fields');
            const weightBtn = document.getElementById('weight-type-btn');
            const cardioBtn = document.getElementById('cardio-type-btn');

            [weightBtn, cardioBtn].forEach(btn => {
                btn.classList.remove('bg-teal-500', 'text-white', 'bg-gray-700', 'text-gray-300');
            });

            if (type === 'weight') {
                weightBtn.classList.add('bg-teal-500', 'text-white');
                cardioBtn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                weightBtn.textContent = 'Weights';
                cardioBtn.textContent = 'Cardio';

                let setInputsHtml = `<label class="block text-sm font-bold text-gray-300 mb-3">Sets Details (Up to ${MAX_SETS})</label>`;
                setInputsHtml += '<div id="sets-container" class="space-y-3">';
                for (let i = 1; i <= MAX_SETS; i++) {
                    setInputsHtml += `
                        <div class="flex space-x-2 items-center p-3 bg-gray-700 rounded-xl border border-gray-600">
                            <span class="font-bold text-gray-300 w-12 text-sm flex-shrink-0">Set ${i}:</span>
                            <div class="flex w-full space-x-2">
                                <input type="number" name="set_weight_${i}" placeholder="Weight (kg)"
                                    class="w-1/2 p-2 bg-gray-800 text-white border border-gray-600 rounded-lg text-sm" min="0" step="0.1">
                                <input type="number" name="set_reps_${i}" placeholder="Reps"
                                    class="w-1/2 p-2 bg-gray-800 text-white border border-gray-600 rounded-lg text-sm" min="0" step="1">
                            </div>
                        </div>
                    `;
                }
                setInputsHtml += '</div>';

                fieldsEl.innerHTML = setInputsHtml;
            } else { // Cardio
                cardioBtn.classList.add('bg-teal-500', 'text-white');
                weightBtn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                weightBtn.textContent = 'Weights';
                cardioBtn.textContent = 'Cardio';

                fieldsEl.innerHTML = `
                    ${createInputField('time', 'Time (e.g., 30 min, 1h)', 'text', 'e.g. 30 min', 'required')}
                    ${createInputField('distance', 'Distance (e.g., 5 km) (Optional)', 'text', 'e.g. 5 km', '')}
                    ${createInputField('speed', 'Avg. Speed (e.g., 10 km/h)', 'text', 'e.g. 10 km/h', 'required')}
                `;
            }
            window.updateDatalistOptions(type);
        };

        function createInputField(id, label, type, placeholder, required = '') {
            return `
                <div>
                    <label for="${id}" class="block text-sm font-semibold text-gray-300 mb-1">${label}</label>
                    <input type="${type}" id="${id}" name="${id}" placeholder="${placeholder}" ${required}
                        class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-xl focus:ring-teal-500 focus:border-teal-500 min-w-0 transition duration-150"
                        ${type === 'number' ? 'min="0" step="0.1"' : ''}>
                </div>
            `;
        }

        window.handleFormSubmit = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const name = form.querySelector('#workout-name').value.trim();
            const date = form.querySelector('#workout-date').value;
            const logBtn = document.getElementById('log-btn');
            
            logBtn.disabled = true; 
            logBtn.innerHTML = window.editingWorkoutId ? 'Saving...' : 'Logging...';
            
            if (!name || !date) {
                window.showFormMessage('Please fill in the exercise name and date.', 'text-red-500');
                logBtn.disabled = false; 
                logBtn.innerHTML = window.editingWorkoutId ? 'Update Workout' : 'Log Workout';
                return;
            }

            const data = {
                id: window.editingWorkoutId || generateId(), // Local ID management
                type: window.currentWorkoutType,
                name: name,
                date: date,
                createdAt: new Date().toISOString() 
            };

            let setFound = false;

            if (window.currentWorkoutType === 'weight') {
                const sets = [];
                
                for (let i = 1; i <= MAX_SETS; i++) {
                    const weightInput = form.querySelector(`input[name="set_weight_${i}"]`);
                    const repsInput = form.querySelector(`input[name="set_reps_${i}"]`);

                    if (!weightInput || !repsInput) continue;

                    const weight = parseFloat(weightInput.value) || 0;
                    const reps = parseInt(repsInput.value) || 0;

                    if (weight > 0 || reps > 0) { 
                        sets.push({
                            set: i,
                            weight: weight, 
                            reps: reps 
                        });
                        setFound = true;
                    }
                }

                if (!setFound) {
                    window.showFormMessage('Please log at least one set with weight or reps.', 'text-red-500');
                    logBtn.disabled = false; 
                    logBtn.innerHTML = window.editingWorkoutId ? 'Update Workout' : 'Log Workout';
                    return;
                }
                data.sets = sets;
            } else { // Cardio
                const time = form.querySelector('#time').value.trim();
                const speed = form.querySelector('#speed').value.trim();
                
                if (!time || !speed) {
                    window.showFormMessage('Please fill in Time and Avg. Speed for Cardio.', 'text-red-500');
                    logBtn.disabled = false; 
                    logBtn.innerHTML = window.editingWorkoutId ? 'Update Workout' : 'Log Workout';
                    return;
                }

                data.time = time;
                data.distance = form.querySelector('#distance').value.trim() || '0 km';
                data.speed = speed;
            }

            // --- LOCAL STORAGE LOGIC ---
            if (window.editingWorkoutId) {
                // Update existing item
                const index = window.workouts.findIndex(w => w.id === window.editingWorkoutId);
                if (index > -1) {
                    window.workouts[index] = data;
                }
            } else {
                // Add new item
                window.workouts.push(data);
            }

            window.saveWorkoutsToLocal(window.workouts);
            window.addExerciseToHistory(data.name, data.type); 
            window.loadAndRenderWorkouts(); // Re-sort and render
            
            window.showFormMessage(window.editingWorkoutId ? 'Workout updated successfully!' : 'Workout added!', 'text-green-400', 3000);
            window.resetForm();
            window.activateTab('history');
            
            logBtn.disabled = false; 
            logBtn.innerHTML = window.editingWorkoutId ? 'Update Workout' : 'Log Workout';
        };

        window.resetForm = function() {
            document.getElementById('workout-form').reset();
            document.getElementById('workout-date').valueAsDate = new Date(); 
            window.editingWorkoutId = null;
            document.getElementById('log-btn').textContent = 'Log Workout';
            window.setWorkoutType(window.currentWorkoutType); 
            window.showFormMessage('', 'hidden'); 
        };

        window.startEdit = function(id) {
            const workout = window.workouts.find(w => w.id === id);
            if (!workout) return;

            window.editingWorkoutId = id;
            document.getElementById('workout-date').value = workout.date;
            document.getElementById('workout-name').value = workout.name;
            document.getElementById('log-btn').textContent = 'Update Workout';

            window.setWorkoutType(workout.type);

            if (workout.type === 'weight') {
                // Clear all fields first
                for (let i = 1; i <= MAX_SETS; i++) {
                    const weightInput = document.querySelector(`input[name="set_weight_${i}"]`);
                    const repsInput = document.querySelector(`input[name="set_reps_${i}"]`);
                    if (weightInput) weightInput.value = '';
                    if (repsInput) repsInput.value = '';
                }
                // Fill fields
                workout.sets.forEach(set => {
                    const weightInput = document.querySelector(`input[name="set_weight_${set.set}"]`);
                    const repsInput = document.querySelector(`input[name="set_reps_${set.set}"]`);
                    if (weightInput) weightInput.value = set.weight;
                    if (repsInput) repsInput.value = set.reps;
                });
            } else { 
                document.getElementById('time').value = workout.time || '';
                document.getElementById('distance').value = workout.distance || '';
                document.getElementById('speed').value = workout.speed || '';
            }

            // Scroll to the top of the form for mobile UX
            document.getElementById('app').scrollIntoView({ behavior: 'smooth' });
            window.showFormMessage('Editing existing workout. Press "Update Workout" to save.', 'text-yellow-400');
        };
        
        window.deleteWorkout = async function(id) {
            
            const confirmed = await window.showModal('Confirm Delete', 'Are you sure you want to permanently delete this workout entry from this browser?', true);
            if (!confirmed) return;

            // --- LOCAL STORAGE LOGIC ---
            const initialLength = window.workouts.length;
            window.workouts = window.workouts.filter(w => w.id !== id);
            
            if (window.workouts.length < initialLength) {
                window.saveWorkoutsToLocal(window.workouts);
                window.loadAndRenderWorkouts();
                window.showFormMessage('Workout deleted.', 'text-green-400', 3000);
            } else {
                window.showFormMessage('Failed to find workout to delete.', 'text-red-500', 3000);
            }
         };


        // --- Parsing Utilities (Unchanged) ---

        window.parseTime = function(timeStr) {
            const matchMin = timeStr ? timeStr.match(/(\d+)\s*min/i) : null;
            const matchHour = timeStr ? timeStr.match(/(\d+)\s*hour/i) : null;
            let timeInMinutes = 0;

            if (matchMin) {
                timeInMinutes += parseInt(matchMin[1], 10);
            }
            if (matchHour) {
                timeInMinutes += parseInt(matchHour[1], 10) * 60;
            }
            return timeInMinutes;
        };

        window.parseDistance = function(distanceStr) {
            const matchKm = distanceStr ? distanceStr.match(/(\d+(\.\d+)?)\s*km/i) : null;
            const matchMi = distanceStr ? distanceStr.match(/(\d+(\.\d+)?)\s*mi/i) : null;
            let distanceInKm = 0;

            if (matchKm) {
                distanceInKm = parseFloat(matchKm[1]);
            } else if (matchMi) {
                distanceInKm = parseFloat(matchMi[1]) * 1.60934; 
            }
            return distanceInKm;
        };

        window.parseSpeed = function(speedStr) {
            const matchKmh = speedStr ? speedStr.match(/(\d+(\.\d+)?)\s*km\/h/i) : null;
            const matchMph = speedStr ? speedStr.match(/(\d+(\.\d+)?)\s*mph/i) : null;
            let speedInKmh = 0;

            if (matchKmh) {
                speedInKmh = parseFloat(matchKmh[1]);
            } else if (matchMph) {
                speedInKmh = parseFloat(matchMph[1]) * 1.60934; 
            }
            return speedInKmh;
        };

        window.updateDatalistOptions = function(type) {
            const datalist = document.getElementById('exercise-suggestions');
            datalist.innerHTML = '';
            
            const exercises = window.exerciseHistory[type] || [];
            
            exercises.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                datalist.appendChild(option);
            });

            if (type === 'weight') {
                window.updateWeightChartSelector(exercises);
            }
        };

        // --- Charting Logic (Unchanged) ---

        window.renderProgressChart = function(workouts) {
            if (window.currentTab !== 'progress') return;

            const allWeightExercises = Array.from(new Set(workouts
                .filter(w => w.type === 'weight')
                .map(w => w.name)));
            
            window.updateWeightChartSelector(allWeightExercises);

            window.renderWeightChart(workouts, window.weightExercise);

            window.renderCardioChart(workouts, window.cardioMetric);
        };

        window.updateWeightChartSelector = function(exercises) {
            const selector = document.getElementById('weight-exercise-selector');
            const currentSelected = selector.value;
            selector.innerHTML = ''; 

            if (exercises.length === 0) {
                selector.innerHTML = '<option value="">No weight workouts logged</option>';
                window.weightExercise = null;
                return;
            }

            const targetExercise = currentSelected && exercises.includes(currentSelected) 
                ? currentSelected 
                : exercises[0];

            exercises.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selector.appendChild(option);
            });

            selector.value = targetExercise;
            window.weightExercise = targetExercise;
        };

        window.handleWeightExerciseChange = function(exercise) {
            window.weightExercise = exercise;
            window.renderWeightChart(window.workouts, exercise);
        };

        window.renderWeightChart = function(workouts, exerciseName) {
            if (!exerciseName) {
                if (window.charts.weight) window.charts.weight.destroy();
                return;
            }

            const filteredWorkouts = workouts
                .filter(w => w.type === 'weight' && w.name === exerciseName)
                .map(w => {
                    // Calculate Max Lift from recorded sets
                    const maxWeight = w.sets.reduce((max, set) => Math.max(max, set.weight), 0);
                    return { date: w.date, maxWeight };
                })
                .filter(w => w.maxWeight > 0) 
                .reverse(); 

            const data = {
                labels: filteredWorkouts.map(w => new Date(w.date).toLocaleDateString()),
                datasets: [{
                    label: 'Max Lift (kg)',
                    data: filteredWorkouts.map(w => w.maxWeight),
                    borderColor: '#2dd4bf', 
                    backgroundColor: 'rgba(45, 212, 191, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4, 
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#2dd4bf',
                }]
            };

            const ctx = document.getElementById('weight-chart').getContext('2d');
            if (window.charts.weight) window.charts.weight.destroy();

            window.charts.weight = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Weight (kg)',
                                color: '#9ca3af',
                                font: { size: 12 } 
                            },
                            grid: {
                                color: '#374151' 
                            },
                            ticks: {
                                color: '#e5e7eb',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            title: {
                                display: false 
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#e5e7eb',
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        };

        window.handleCardioMetricChange = function(metric) {
            window.cardioMetric = metric;
            window.renderCardioChart(window.workouts, metric);
        };

        window.renderCardioChart = function(workouts, metric) {
            const cardioWorkouts = workouts.filter(w => w.type === 'cardio').reverse();
            let label = '';
            let unit = '';
            let dataPoints = [];

            switch(metric) {
                case 'distance':
                    label = 'Total Distance';
                    unit = 'km';
                    dataPoints = cardioWorkouts.map(w => window.parseDistance(w.distance));
                    break;
                case 'time':
                    label = 'Total Time';
                    unit = 'min';
                    dataPoints = cardioWorkouts.map(w => window.parseTime(w.time));
                    break;
                case 'speed':
                    label = 'Average Speed';
                    unit = 'km/h';
                    dataPoints = cardioWorkouts.map(w => window.parseSpeed(w.speed));
                    break;
            }

            const data = {
                labels: cardioWorkouts.map(w => new Date(w.date).toLocaleDateString()),
                datasets: [{
                    label: `${label} (${unit})`,
                    data: dataPoints,
                    borderColor: '#60a5fa', 
                    backgroundColor: 'rgba(96, 165, 250, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4, 
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#60a5fa',
                }]
            };

            const ctx = document.getElementById('cardio-chart').getContext('2d');
            if (window.charts.cardio) window.charts.cardio.destroy();

            window.charts.cardio = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `${label} (${unit})`,
                                color: '#9ca3af',
                                font: { size: 12 }
                            },
                            grid: {
                                color: '#374151' 
                            },
                            ticks: {
                                color: '#e5e7eb',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            title: {
                                display: false
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#e5e7eb',
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        };

        // --- Initial Load ---
        window.setupEventListeners();
        
    </script>
</body>
</html>

